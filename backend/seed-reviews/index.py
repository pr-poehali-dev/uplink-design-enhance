import json
import os
from datetime import datetime
import psycopg2

def handler(event: dict, context) -> dict:
    '''Заполнение базы данных начальными отзывами'''
    method = event.get('httpMethod', 'GET')
    
    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type'
            },
            'body': '',
            'isBase64Encoded': False
        }
    
    if method != 'POST':
        return {
            'statusCode': 405,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'error': 'Method not allowed'}),
            'isBase64Encoded': False
        }
    
    db_url = os.environ.get('DATABASE_URL')
    if not db_url:
        return {
            'statusCode': 500,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'error': 'Database not configured'}),
            'isBase64Encoded': False
        }
    
    reviews = [
        ('Дмитрий Соколов', 'ООО "Спектр"', 'Ребята установили видеонаблюдение в наш офис. Работой доволен, всё чётко и быстро. Единственное, немного задержали с монтажом на пару дней из-за нехватки кабеля, но в итоге всё сделали качественно. Рекомендую!', 4, '2025-12-15'),
        ('Анна Кузнецова', None, 'Отличная компания! Ставили домофон и камеры во дворе частного дома. Инженеры приехали вовремя, всё объяснили, показали как пользоваться. Работают аккуратно, мусор за собой убрали. Цена адекватная. Спасибо большое!', 5, '2025-12-20'),
        ('Сергей Петрович', 'Магазин "Продукты 24"', 'Устанавливали систему безопасности в магазин - камеры, сигнализация, контроль доступа. Всё работает как часы уже полгода. Монтаж быстрый, цена справедливая. Молодцы, знают своё дело!', 5, '2025-11-28'),
        ('Ольга Васильева', None, 'Поставили камеры наблюдения на даче. В целом хорошо, но были небольшие косяки с настройкой приложения для просмотра с телефона - пришлось вызывать ребят повторно. Но приехали быстро, всё поправили бесплатно. В остальном претензий нет.', 4, '2026-01-05'),
        ('Александр Морозов', 'ТЦ "Горизонт"', 'Делали полную систему безопасности для торгового центра - 45 камер, пожарная сигнализация, СКУД. Проект сложный, но справились на отлично! Работали организованно, соблюдали сроки. Особенно порадовала техподдержка после установки. Однозначно 5 звёзд!', 5, '2025-11-10'),
        ('Мария Новикова', None, 'Спасибо за качественную работу! Ставили видеонаблюдение в подъезде по инициативе жильцов. Приехали в удобное время, сделали быстро и недорого. Теперь спокойно оставляем коляски в подъезде - всё под контролем)', 5, '2026-01-12'),
        ('Виктор Иванович', 'Автосервис "Мастер"', 'Монтировали камеры и сигнализацию в автосервисе. Работа выполнена хорошо, но немного напрягло что мастер опоздал на час в первый день. Ну и цена оказалась чуть выше сметы из-за дополнительных материалов. В целом результат устраивает, система работает без нареканий.', 4, '2025-12-03'),
        ('Екатерина Лебедева', None, 'Очень довольна! Установили умный домофон с видеосвязью и камеру над входной дверью в квартиру. Мастер всё подробно рассказал, даже дал советы по безопасности. Монтаж аккуратный, ничего не испортили. Цена честная. Буду рекомендовать знакомым!', 5, '2025-12-28'),
        ('Игорь Романов', 'Складской комплекс', 'Заказывали полную систему безопасности для склада - периметр, въездные группы, внутреннее наблюдение. Объём большой, но команда справилась за 2 недели. Качество отличное, всё документально оформлено. Пользуемся уже 3 месяца - полёт нормальный. Рекомендую для серьёзных объектов!', 5, '2025-10-22')
    ]
    
    try:
        conn = psycopg2.connect(db_url)
        cur = conn.cursor()
        
        inserted_count = 0
        for name, company, text, rating, date_str in reviews:
            cur.execute(
                'INSERT INTO reviews (name, company, text, rating, date) VALUES (%s, %s, %s, %s, %s)',
                (name, company, text, rating, date_str)
            )
            inserted_count += 1
        
        conn.commit()
        cur.close()
        conn.close()
        
        return {
            'statusCode': 200,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'success': True, 'inserted': inserted_count}, ensure_ascii=False),
            'isBase64Encoded': False
        }
    
    except Exception as e:
        if 'conn' in locals():
            conn.close()
        return {
            'statusCode': 500,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'error': str(e)}),
            'isBase64Encoded': False
        }
